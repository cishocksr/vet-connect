# ============================================
# PRODUCTION CONFIGURATION
# ============================================
# This file is automatically loaded when SPRING_PROFILES_ACTIVE=prod
# It overrides settings from application.yml

spring:
  # JPA Configuration
  jpa:
    show-sql: false  # CRITICAL: Never show SQL in production logs
    hibernate:
      ddl-auto: none  # Never auto-update schema in production
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        # Enable query performance logging
        session:
          events:
            log:
              LOG_QUERIES_SLOWER_THAN_MS: 1000  # Log queries slower than 1 second
        # Additional performance settings
        jdbc:
          batch_size: 20  # Batch inserts for better performance
        order_inserts: true
        order_updates: true
        # Query plan cache
        query:
          plan_cache_max_size: 2048
          plan_parameter_metadata_max_size: 128

  # Datasource Configuration
  datasource:
    hikari:
      # Production connection pool settings
      maximum-pool-size: ${DB_POOL_MAX:20}
      minimum-idle: ${DB_POOL_MIN:5}
      connection-timeout: 20000  # 20 seconds to get connection from pool
      idle-timeout: 300000  # 5 minutes - close idle connections
      max-lifetime: 600000  # 10 minutes - maximum connection lifetime

      # Connection validation
      connection-test-query: SELECT 1  # Test query before giving connection
      validation-timeout: 5000  # 5 seconds timeout for validation

      # Leak detection (helps find connection leaks during testing)
      leak-detection-threshold: 60000  # 60 seconds - log warning if connection held too long

      # Pool name for monitoring
      pool-name: VetConnectHikariPool

      # Additional production settings
      auto-commit: true
      register-mbeans: true  # Enable JMX monitoring

  # Liquibase - ensure migrations run
  liquibase:
    enabled: true
    drop-first: false  # NEVER drop database in production

# Server Configuration
server:
  port: 8080
  # Stricter limits in production
  max-http-request-header-size: 10KB
  tomcat:
    max-swallow-size: 5MB
    max-http-form-post-size: 1MB
  error:
    include-message: always
    include-binding-errors: never  # Don't expose binding errors in production
    include-stacktrace: never  # CRITICAL: Never expose stack traces
    include-exception: false
  # Enable compression for better performance
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
    min-response-size: 1024  # Compress responses larger than 1KB
  # Security: Session cookies
  servlet:
    session:
      cookie:
        secure: true  # Only send cookies over HTTPS
        http-only: true  # Prevent JavaScript access to cookies
        same-site: strict  # CSRF protection

# Logging Configuration
logging:
  level:
    root: WARN  # Only show warnings and errors by default
    com.vetconnect: INFO  # Our application at INFO level
    org.springframework.security: WARN  # Reduce security noise
    org.springframework.web: WARN
    org.hibernate.SQL: WARN  # Don't log SQL queries
    org.hibernate.type.descriptor.sql.BasicBinder: WARN  # Don't log SQL parameters
  pattern:
    # Include request ID in log pattern for request tracing
    console: "%d{yyyy-MM-dd HH:mm:ss} [%X{requestId}] [%thread] %-5level %logger{36} - %msg%n"
  # File logging (optional - usually use external log aggregation in production)
  file:
    name: ${LOG_FILE:/var/log/vet-connect/application.log}
    max-size: 10MB
    max-history: 30  # Keep 30 days of logs
    total-size-cap: 1GB

# Springdoc OpenAPI (Swagger) - DISABLED IN PRODUCTION
springdoc:
  api-docs:
    enabled: false
  swagger-ui:
    enabled: false

# Management & Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info  # Only expose health and info publicly
        # Metrics and prometheus require authentication (configured in SecurityConfig)
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized  # Only show details to authenticated users
      probes:
        enabled: true  # Enable Kubernetes liveness/readiness probes
  metrics:
    distribution:
      percentiles-histogram:
        http.server.requests: true  # Track request latency percentiles
    tags:
      application: ${spring.application.name}
      environment: prod