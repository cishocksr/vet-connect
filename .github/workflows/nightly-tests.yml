name: Nightly Tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggers

jobs:
  # Comprehensive test suite with extended timeouts
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: vetconnect_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: 'apps/backend/pom.xml'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      # Run all tests with coverage
      - name: Run full test suite with coverage
        run: pnpm test:coverage:ci
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: vetconnect_test
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      # Generate comprehensive coverage reports
      - name: Generate backend coverage badge
        id: jacoco
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: apps/backend/target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-branches-badge: true
          generate-summary: true

      - name: Upload backend coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/backend/target/site/jacoco/jacoco.xml
          flags: backend,nightly
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

      - name: Upload frontend coverage
        uses: codecov/codecov-action@v4
        with:
          directory: ./apps/frontend/coverage/
          flags: frontend,nightly
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

      # Archive test reports
      - name: Archive backend test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: |
            apps/backend/target/surefire-reports/
            apps/backend/target/site/jacoco/
          retention-days: 30

      - name: Archive frontend test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-reports
          path: apps/frontend/coverage/
          retention-days: 30

  # Integration tests (if you add them later)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: vetconnect_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: 'apps/backend/pom.xml'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      # Build everything first
      - name: Build all packages
        run: pnpm build
        env:
          VITE_API_BASE_URL: http://localhost:8080/api
          VITE_ENVIRONMENT: test

      # Placeholder for future integration tests
      - name: Run integration tests
        run: |
          echo "Integration tests will be added here"
          echo "This could include:"
          echo "  - API contract tests"
          echo "  - End-to-end tests"
          echo "  - Database migration tests"
          echo "  - Performance tests"

  # Performance benchmarks
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: vetconnect_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: 'apps/backend/pom.xml'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      # Placeholder for performance tests
      - name: Run performance benchmarks
        run: |
          echo "Performance benchmarks will be added here"
          echo "This could include:"
          echo "  - Load testing"
          echo "  - Response time benchmarks"
          echo "  - Memory usage profiling"
          echo "  - Database query performance"

  # Dependency audit
  security-audit:
    name: Security & Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      # Audit npm dependencies
      - name: Run pnpm audit
        run: pnpm audit --prod
        continue-on-error: true

      # Check for outdated dependencies
      - name: Check for outdated dependencies
        run: pnpm outdated
        continue-on-error: true

      # Maven dependency check
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: 'apps/backend/pom.xml'

      - name: Maven dependency check
        working-directory: ./apps/backend
        run: mvn dependency:tree
        continue-on-error: true

  # Notification on failure
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [full-test-suite, integration-tests, performance-tests, security-audit]
    if: failure()

    steps:
      - name: Send notification
        run: |
          echo "Nightly tests failed!"
          echo "Check the workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add Slack/Discord/Email notification here if needed

  # Summary job
  nightly-complete:
    name: Nightly Tests Complete
    runs-on: ubuntu-latest
    needs: [full-test-suite, integration-tests, performance-tests, security-audit]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "Full Test Suite: ${{ needs.full-test-suite.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Performance Tests: ${{ needs.performance-tests.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          
          if [[ "${{ needs.full-test-suite.result }}" != "success" ]]; then
            echo "::error::Full test suite failed"
            exit 1
          fi
          
          echo "Nightly tests completed!"